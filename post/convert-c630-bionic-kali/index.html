<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Converting a Bionic install to Kali on the Lenovo C630 &middot; </title>
        <meta name="description" content="Converting a Bionic install to Kali on the Lenovo C630">
        <meta name="HandheldFriendly" content="True">
        <meta name="MobileOptimized" content="320">
        <meta name="generator" content="Hugo 0.80.0" />
        <meta name="robots" content="index,follow">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <link rel="stylesheet" href="https://steev.netdist/site.css">
        <link rel="stylesheet" href="https://steev.netdist/syntax.css">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,700,300&subset=latin,cyrillic-ext,latin-ext,cyrillic">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
        
        
        
        
        

    </head>
    <body>
        

        <div id="wrapper">
            <header class="site-header">
                <div class="container">
                    <div class="site-title-wrapper">
                        
                            <h1 class="site-title">
                                <a href="https://steev.net">STEEVdotnet</a>
                            </h1>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    </div>

                    <ul class="site-nav">
                        

                    </ul>
                </div>
            </header>

            <div id="container">


<div class="container">
    <article class="post-container" itemscope="" itemtype="http://schema.org/BlogPosting">
        <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Converting a Bionic install to Kali on the Lenovo C630</h1>
    
        <p class="post-description" itemprop="description">Converting a Bionic install to Kali on the Lenovo C630</p>
    
    <p class="post-date post-line">
        <span>Published <time datetime="2020-05-30" itemprop="datePublished">May 30, 2020</time></span>
        <span>by</span>
        <span itemscope="" itemprop="author" itemtype="https://schema.org/Person">
            <span itemprop="name">
                <a href="#" itemprop="url" rel="author">Steev Klimaszewski</a>
            </span>
        </span>
    </p>
    
</header>

        <div class="post-content clearfix" itemprop="articleBody">
    

    <p>Since I&rsquo;m a Kali developer for my day job, I like to &ldquo;dogfood&rdquo; and run Kali on most of my machines.  Recently, since the majority of the support is in a 5.7-ish kernel, I went ahead and installed Bionic to a partition on the internal storage, and then went about &ldquo;upgrading&rdquo; it to run Kali instead of the Bionic install.  This will be a bit of a walkthrough to show how I did it, and can be used as a general guide for converting an Ubuntu install to Kali, without reinstalling.</p>
<p>First thing I did was follow the steps listed at <a href="https://github.com/aarch64-laptops/build">https://github.com/aarch64-laptops/build</a> under <code>Use an enabled installer</code> - I personally did minimal install because I knew I&rsquo;d be converting to a Kali installation afterwards.</p>
<p>After first booting into Ubuntu, I went ahead and disabled natural scrolling and turned on tap to click in the settings, and connecting to my wifi network using an external device, as the 5.2 kernel does not support the built-in wifi card.  An ethernet connection would work as well if you have one on a usb-c hub, but my hub recently died so&hellip;</p>
<p>Then I purged both snapd and unattended-upgrades - I did NOT autoremove anything, as I don&rsquo;t want to do that til near the end of converting to Kali.  We remove snapd because Kali doesn&rsquo;t use snapd, and unattended-upgrades because&hellip; I don&rsquo;t like apt running things in the background behind my back.</p>
<p><code>sudo apt purge snapd unattended-upgrades</code></p>
<p>Now we download the Kali archive keyring, so that we can install packages from the Kali distro.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">wget https://kali.download/kali/pool/main/k/kali-archive-keyring/kali-archive-keyring_2020.2_all.deb
sudo dpkg -i ./kali-archive-keyring_2020.2_all.deb
</code></pre></div><p>Now we edit the <code>/etc/sources.list</code> so that we point to the Kali repos.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">deb https://http.kali.org/kali kali-rolling main contrib non-free
</code></pre></div><p>Because of the grub packages having some changes, we&rsquo;ll go ahead and <code>apt-mark hold</code> the grub packages.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo apt-mark hold grub2-common
sudo apt-mark hold grub-efi-arm64-bin
sudo apt-mark hold grub-efi-arm64
sudo apt-mark hold grub-common
</code></pre></div><p>Also, because we&rsquo;re going to be regenerating the initramfs a few times as part of this process, let&rsquo;s put the dtb file where flash-kernel can find it&hellip;</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo mkdir -p /etc/flash-kernel/dtbs/qcom
sudo cp /boot/dtbs/5.2.0-99-generic/laptop-lenovo-yoga-c630.dtb /etc/flash-kernel/dtbs/qcom/
</code></pre></div><hr>
<h5 id="now-we-can-start-breaking-things">Now we can start breaking things&hellip;</h5>
<p>Update our repository information, and then do the dist-upgrade, passing a few options because, well, I don&rsquo;t really want to babysit it, and I know some contents have changed packages, and won&rsquo;t update cleanly.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo apt update
sudo apt dist-upgrade --download-only <span class="c1"># This allows us to download all the updates, before running the update command.</span>
sudo env <span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive dist-upgrade -o dpkg::options::<span class="o">=</span>--force-confnew -o dpkg::options::<span class="o">=</span>--force-overwrite
</code></pre></div><p>Go grab a cup of coffee, or your preferred beverage of choice.</p>
<p>Once the update completes, we need to &ldquo;downgrade&rdquo; a few packages, because Ubuntu changes the epoch in their package version so it only ever updates to theirs despite new versions coming in from Debian, and Kali tends to follow Debian&rsquo;s versioning a bit closer.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo apt install --allow-downgrades libnautilus-extension1a<span class="o">=</span>3.36.2-2 nautilus-data<span class="o">=</span>3.36.2-2 python3-software-properties-0.96.20.2-2.1 libgudev-1.0-0<span class="o">=</span>233.1 gcc-8-base
</code></pre></div><p>Now lets install the Kali metapackages&hellip;</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo apt install kali-desktop-gnome <span class="c1"># You can also use kali-desktop-xfce, but for now, I&#39;d suggest sticking with gnome due to the mesa issue that hasn&#39;t been patched just yet in Debian.</span>
</code></pre></div><p>We&rsquo;re gonna have a bit of repeats here, because once we&rsquo;ve done these updates, we&rsquo;re going to remove a bunch of packages, and part of that will likely uninstall the Kali metapackages as well.
But now we&rsquo;re going to remove Ubuntu specific packages, or packages that we&rsquo;re not going to be using.  I got this list with a fairly quick <code>dpkg -l | grep ubuntu</code> so you may want to check that output, rather than blindly copying in my command below.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo apt purge adium-theme-ubuntu alsa-base apport apport-gtk aptdaemon aptdaemon-data apturl-common dmz-cursor-theme fonts-khmeros-core fonts-lao gcc-7-base gnome-accessibility-themese gnome-shell-extension-ubuntu-dock gnome-themes-extra gnome-themes-extra-data gsettings-ubuntu-schemas kerneloops libao-common libappindicator3-1 libappindicator37 libprocps6 libpulse-mainloop-glib0 libpulse0 libpulsedsp libsane1 libssl1.0.0 libwhoopsie0 libxcb-util1 linux-firmware linux-sound-base ltrace multiarch-support network-manager-config-connectivity-ubuntu nplan perl-modules-5.26 pppoeconf printer-driver-pnm2ppa pulseaudio pulseaudio-module-bluetooth pulseaudio-utils python3-apport python3-aptdaemon python3-aptdaemon.gtk3widgets python3-xkit sound-theme-freedesktop ubuntu-advantage-tools ubuntu-artwork ubuntu-docs ubuntu-drivers-common ubuntu-keyring ubuntu-minimal ubuntu-mono ubuntu-release-upgrader-core ubunt-release-upgrader-gtk ubuntu-report ubuntu-settings ubuntu-software ubuntu-sounds ubuntu-standard ubuntu-system-service ubuntu-wallpapers ubuntu-wallpapers-bionic whoopsie xserver-xorg-input-wacom xul-ext-ubufox
</code></pre></div><p>Now, this likely also removed some of our wanted Kali packages, so to be sure we get them back, we&rsquo;re going to reinstall the gnome desktop, and then we will install the <code>kali-linux-default</code> metapackage which gives us the packages that a default Kali installation would have.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo apt install kali-desktop-gnome
sudo apt install kali-linux-default
</code></pre></div><p>At this point, before rebooting, you would want to follow the steps from my previous post for upgrading the kernel.  I happen to have the packages still, for the kernel, and mesa, so I don&rsquo;t need to rebuild them, but I do need to make a couple small modifications when upgrading to 5.7.0-rc7, which is the current kernel version I&rsquo;m patching.</p>
<p>Remember how earlier we put the dtb file into place so flash-kernel doesn&rsquo;t complain?  Well now we need to remove it, and we also need to update the flash-kernel database because the 5.7 kernel changes the name of the dtb file we use.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo rm -rf /etc/flash-kernel/dtbs/qcom
sudo <span class="nv">$EDITOR</span> /usr/share/flash-kernel/db/aarch64-laptops.db
</code></pre></div><p>In the aarch64-laptops.db file, we want to change the last line, from the old dtb filename, to the new one.  The line should now be
<code>DTB-Id: qcom/sdm850-lenovo-yoga-c630.dtb</code>.</p>
<p>Now that we&rsquo;ve made this change, we can go ahead an install our 5.7 kernel debs</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo dpkg -i kernel*.deb
</code></pre></div><p>If you&rsquo;ve also rebuilt mesa with the freedreno fix, you probably want to install those now as well. Locally, I&rsquo;ve just gone ahead and cloned the mesa repo from debian, added the patch for freedreno into the debian build sources for 20.0 (debian-unstable branch) and then built the packages, and then we go ahead and install them.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo apt install ./libegl-mesa0_20.0.7-1_arm64.deb ./libgbm1_20.0.7-1_arm64.deb ./libgl1-mesa-dri_20.0.7-1_arm64.deb ./libgl1-mesa-glx_20.0.7-1_arm64.deb ./libglapi-mesa_20.0.7-1_arm64.deb ./libglx-mesa0_20.0.7-1_arm64.deb ./mesa-va-drivers_20.0.7-1_arm64.deb ./mesa-vdpau-drivers_20.0.7-1_arm64.deb ./mesa-vulkan-drivers_20.0.7-1_arm64.deb
</code></pre></div><p>At this point, we should be good to reboot into our &ldquo;new&rdquo; Kali installation.</p>
<hr>
<p>As of June 16, 2020, we have Mesa 20.1.1 in Kali, which includes the freedreno fix, so there&rsquo;s no need to build the mesa packages anymore.</p>

</div>

        <footer class="post-footer clearfix">
        <p class="post-tags">
            <span>Tagged:</span>
                <a href="/tags/text/">text</a>, 
                <a href="/tags/linux/">linux</a>, 
                <a href="/tags/c630/">c630</a>, 
                <a href="/tags/lenovo/">lenovo</a>, 
                <a href="/tags/arm64/">arm64</a>, 
                <a href="/tags/kali/">kali</a>
        </p>
    <div class="share">
    </div>
</footer>

        
    </article>
</div>

            </div>
        </div>

        <footer class="footer">
            <div class="container">
                <div class="site-title-wrapper">
                    <h1 class="site-title">
                        <a href="https://steev.net">STEEVdotnet</a>
                    </h1>
                    <a class="button-square button-jump-top js-jump-top" href="#" aria-label="Back to Top">
                        <i class="fa fa-angle-up" aria-hidden="true"></i>
                    </a>
                </div>

                <p class="footer-copyright">
                    <span>&copy; 2021 / Powered by <a href="https://gohugo.io/">Hugo</a></span>
                </p>
                <p class="footer-copyright">
                    <span><a href="https://github.com/roryg/ghostwriter">Ghostwriter theme</a> By <a href="http://jollygoodthemes.com">JollyGoodThemes</a></span>
                    <span>/ <a href="https://github.com/jbub/ghostwriter">Ported</a> to Hugo By <a href="https://github.com/jbub">jbub</a></span>
                </p>
            </div>
        </footer>

        <script src="https://steev.netjs/jquery-1.11.3.min.js"></script>
        <script src="https://steev.netjs/jquery.fitvids.js"></script>
        <script src="https://steev.netjs/scripts.js"></script>
    </body>
</html>

